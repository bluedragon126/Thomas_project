<?php

/**
 * Btforum
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    sisterbt
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class Btforum extends BaseBtforum
{
	/**
	 * Gives the no. of reply to a topic
	 * $id Id of the topic.
	 */
	 public function getReplyCount($id)
	 {
		$reply_cnt_cri = Doctrine_Query::create()
	   					  ->from('Btforum btf')
						  ->where('btf.koppling = ? AND btf.amne!= ?', array($id,'ja'));
		
		$data = $reply_cnt_cri->execute();
		return count($data);
	 }
	 
	/**
	 * Gives the category of the topic
	 * $id Id of the topic.
	 */
	 public function getCategoryName($id)
	 {
	 	if(!$id)
		{
			$id = $this->btforum_category_id;
		}
		$category_name_cri = Doctrine_Query::create()
	   					  ->from('BtforumCategory btc')
						  ->where('btc.id = ?', $id);
		
		$data = $category_name_cri->fetchOne();
		return $data ? $data->btforum_category_name : '-';
	 }
	 
	/**
	 * Gives the sub category of the topic
	 * $id Id of the topic.
	 */
	 public function getSubCategoryName($id)
	 {
	 	if(!$id)
		{
			$id = $this->btforum_subcategory_id;
		}
		$sub_category_name_cri = Doctrine_Query::create()
	   					  ->from('BtforumSubcategory btsc')
						  ->where('btsc.id = ?', $id);
		
		$data = $sub_category_name_cri->fetchOne();
		return $data ? $data->btforum_subcategory_name : '-';
	 }
	 
	/**
	 * Sets the parent link after new topic is created.
	 * $id Id of the topic.
	 */
	 public function setKoppling($id)
	 {
		$category_name_cri = Doctrine_Query::create()
       						->update('Btforum b')
       						->set('b.koppling', '?', $id)
       						->where('b.id = ?', $id);

    	$updated = $category_name_cri->execute();
	 }
	 
	/**
	 * Sets the parent id after new reply is posted.
	 * $id Id of the topic.
	 */
	 public function setReplyKoppling($id,$parentid)
	 {
		$category_name_cri = Doctrine_Query::create()
       						->update('Btforum b')
       						->set('b.koppling', '?', $parentid)
       						->where('b.id = ?', $id);

    	$updated = $category_name_cri->execute();
	 }
	 
	 
	/**
	 * Sets the reply count after new reply is posted.
	 * $id Id of the topic.
	 */
	 public function setReplyCount($id,$count)
	 {
		$category_name_cri = Doctrine_Query::create()
       						->update('Btforum b')
       						->set('b.ant_inlagg', '?', $count)
       						->where('b.id = ?', $id);

    	$updated = $category_name_cri->execute();
	 }
	 
	/**
	 * Returns specific topic.
	 * $id Id of the topic.
	 */
	 public function fetchTopic($id)
	 {
		$one_topic_cri = Doctrine_Query::create()
	   					   ->from('Btforum btf')
						   ->where('btf.id = ?', $id);
		
		$one_topic_data = $one_topic_cri->fetchOne();
		return $one_topic_data;
	 }
	 
	/**
	 * Returns all records with specific parent id.
	 * $id Id of the topic.
	 */
	 public function fetchForumTopicReply($id)
	 {
		$reply_to_topic_cri = Doctrine_Query::create()
	   					   ->from('Btforum btf')
						   ->where('btf.koppling = ? AND btf.amne!= ?', array($id,'ja'))
						   ->orderBy('btf.datum DESC');
		
		$reply_data = $reply_to_topic_cri->execute();
		return $reply_data;
	 }
	 
	 /**
	 * Returns all records with specific parent id.
	 * $id Id of the topic.
	 */
	 public function fetchForumTopicReplyQuery($id)
	 {
		$reply_to_topic_cri = Doctrine_Query::create()
	   					   ->from('Btforum btf')
						   ->where('btf.koppling = ? AND btf.amne!= ?', array($id,'ja'))
						   ->orderBy('btf.datum ASC');
		return $reply_to_topic_cri;
	 }
	 
	/**
	 * Increments the view count of forum.
	 * $id Id of the topic.
	 */
	 public function increaseViewCount($id)
	 {
		$fetch_one_cri = Doctrine_Query::create()
       						->from('Btforum btf')
       						->where('btf.id = ?', $id);

    	$rec = $fetch_one_cri->fetchOne();
		
		$total = 0;
		
		if($rec)
		{
			$total = $rec->visningar + 1;
			
			$category_name_cri = Doctrine_Query::create()
								->update('Btforum b')
								->set('b.visningar', '?', $total)
								->where('b.id = ?', $id);
	
			$updated = $category_name_cri->execute();
		}

	 }
	 
	/**
	 * Sets the text for a perticular topic.
	 * $id Id of the topic.
	 */
	 public function setForumPost($id,$textarea)
	 {
		$category_name_cri = Doctrine_Query::create()
       						->update('Btforum b')
       						->set('b.textarea', '?', $textarea)
       						->where('b.id = ?', $id);

    	$updated = $category_name_cri->execute();
	 }
	 
	 /**
	 * Returns all records with specific parent id.
	 * $id Id of the topic.
	 */
	 public function fetchAllRecordWithId($id)
	 {
		$query = Doctrine_Query::create()
	   					   ->from('Btforum btf')
						   ->where('btf.koppling = ?',$id)
						   ->orderBy('btf.datum DESC');
		
		$data = $query->execute();
		
		foreach($data as $rec)
		{
			$rec->delete();
		}
	 }
   public function delArticleCommentData($id){  
      
            $del_comment_query = Doctrine_Query::create()
                ->delete('Btforum btf')
                ->where('btf.id = ?',$id);

            $rows = $del_comment_query->execute();
            return $rows;    
            //echo $del_comment_query->getSqlQuery();
            
        }
}