<?php

/**
 * ContactEnquiry
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    sisterbt
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class ContactEnquiry extends BaseContactEnquiry
{

	/*
	*
	* This function fetches record.
	*
	*/
	public function fetchEnquiryRec($id)
	{ 
		$query = Doctrine_Query::create()
	   		   ->from('ContactEnquiry ce')
			   ->where('ce.id = ?', $id);

		$data = $query->fetchOne();
		return $data;
	}
        
	/*
	*
	* This function fetches record for front end.
	*
	*/
	public function fetchEnquiryRecViewArea($id)
	{ 
		$query = Doctrine_Query::create()
	   		   ->from('ContactEnquiry ce')
			   ->where('ce.id = ?', $id)
                           ->addwhere('ce.is_answered != ?', 2);

		$data = $query->fetchOne();
		return $data;
	}

	/*
	*
	* This function returns string which contains searched parameters for search enquiry.
	*
	*/
	
	public function getSearchedEnquiryParameterString($arr,$column_id,$order)
	{ 
		$name_flag = $type_flag = 0;
		$query = Doctrine_Query::create()
                        ->select('cep.*, ce.*, IFNULL(max(cep.reply_date),ce.enq_date) as maxreplydate')
                        ->from('ContactEnquiry ce')                        
                        ->leftJoin('ce.ContactEnquiryPost cep ON ce.id = cep.enq_id');
                
		if($arr['enq_subject'] && $arr['enq_subject']!='')
		{ 
			$query = $query->where("ce.firstname LIKE '%".$arr['enq_subject']."%'");
			$query = $query->orWhere("ce.lastname LIKE '%".$arr['enq_subject']."%'");
			$query = $query->orWhere("ce.email LIKE '%".$arr['enq_subject']."%'");
                        
                        //code added by sandeep
                        $query = $query->orWhere("ce.enq_subject LIKE '%".$arr['enq_subject']."%'");
			$query = $query->orWhere("ce.user_question LIKE '%".$arr['enq_subject']."%'");
			$query = $query->orWhere("cep.reply_text LIKE '%".$arr['enq_subject']."%'");
                        $query = $query->orWhere("cep.author_name LIKE '%".$arr['enq_subject']."%'");
                        //code added by sandeep end
			$name_flag = 1;
		}
		if (isset($arr["enq_type"]) && $arr["enq_type"] != "")
		{
			if($name_flag == 1) $query = $query->andWhere("ce.enq_type = ?",$arr['enq_type']);
			else $query = $query->where("ce.enq_type = ?",$arr['enq_type']);
			$type_flag = 1;
		}
		
		$order = trim($order);
		$ans_type = trim(str_replace('ans_','',$arr['ans_type']));
		switch($column_id)
		{
			case 'subject': 
							if($type_flag == 1 || $name_flag == 1)	
								$query = $query->andWhere('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('ce.enq_subject '.$order); 
							else $query = $query->where('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('ce.enq_subject '.$order); 
							
							break;
			case 'enq_type': 
							if($type_flag == 1 || $name_flag == 1)	
								$query = $query->andWhere('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('ce.enq_type '.$order);
							else $query = $query->where('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('ce.enq_type '.$order);
							
							break;
			case 'firstname': 
							if($type_flag == 1 || $name_flag == 1)	
								$query = $query->andWhere('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('ce.firstname '.$order);
							else $query = $query->where('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('ce.firstname '.$order);
							
							break;
			case 'lastname': 
							if($type_flag == 1 || $name_flag == 1)	
								$query = $query->andWhere('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('ce.lastname '.$order);
							else $query = $query->where('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('ce.lastname '.$order);
							
							break;
			case 'email': 
							if($type_flag == 1 || $name_flag == 1)	
								$query = $query->andWhere('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('ce.email '.$order);
							else $query = $query->where('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('ce.email '.$order);
							
							break;
			case 'date': 
							if($type_flag == 1 || $name_flag == 1)	
								$query = $query->andWhere('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('maxreplydate '.$order);
							else $query = $query->where('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('maxreplydate '.$order);
							
							break;
			case 'default': 
							if($type_flag == 1 || $name_flag == 1)	
								$query = $query->andWhere('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('ce.enq_date '.$order);
							else $query = $query->where('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('ce.enq_date '.$order);
							
							break;
		}
		if(!$column_id)
		{ 
			if($type_flag == 1 || $name_flag == 1)	$query = $query->andWhere('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('maxreplydate DESC, ce.enq_date desc');//->orderBy('ce.enq_date DESC'); 
			else $query = $query->where('ce.is_answered = '.$ans_type)->groupBy('ce.id')->orderBy('maxreplydate DESC, ce.enq_date desc'); //->orderBy('ce.enq_date DESC'); 
		}
		//echo $query->getSqlQuery();
		return $query;
	}
	
	/*
	*
	* This function updates enquiery records.
	*
	*/
	public function updateEnquiryRecords($arr)
	{ 
		// Change status of selected Enquiries
		if($arr['enquiry_ids'])
		{
			foreach ($arr['enquiry_ids'] as $key => $value)
			{
				$update_enquiry_data = $this->fetchEnquiryRec($value);
				
				if($arr['enq_status'][$key] != "") 
				{
					$update_enquiry_data->is_answered = $arr['enq_status'][$key];
					$update_enquiry_data->save();
				}
			}
		}
	}
	
	/*
	*
	* This function fetches the last conversation.
	*
	*/
	public function getLastEnquiryPost($comm_id)
	{ 
		$query = Doctrine_Query::create()->from('ContactEnquiry ce');
		$query = $query->where('ce.comm_id = ?', $comm_id);
		$data = $query->fetchOne();
		return $data;
	}
	
	/*
	*
	* This function fetches record according to ans status.
	*
	*/
	public function getStatusOfRecordQuery($ans_id)
	{ 
		$ans_id = trim(str_replace('ans_','',$ans_id)); 
		$query = Doctrine_Query::create()->from('ContactEnquiry ce')->where('ce.is_answered = ?', $ans_id)->orderBy('ce.enq_date DESC');
		return $query;
	}
        
        //code change by sandeep
        public function checkEmailInContactEnquiry($email_id)
	{ 
		$query = Doctrine_Query::create()->from('ContactEnquiry ce');
		$query = $query->where('ce.email = ?', $email_id);
		$data = $query->fetchArray();
		return $data;
	}
        //code change by sandeep end
        
        
        public function getAllNewContactEnquiryPostQuery() 
	{
		/*$all_contact_post = Doctrine_Query::create()
						  ->from('ContactEnquiry ce')
						  ->orderBy('ce.enq_date DESC');*/
                
                $all_contact_post = Doctrine_Query::create()
                        ->select('cep.*, ce.*, IFNULL(max(cep.reply_date),ce.enq_date) as maxreplydate')
                        ->from('ContactEnquiry ce')
                        ->leftJoin('ce.ContactEnquiryPost cep ON ce.id = cep.enq_id')
                        ->where('ce.faster_ans_flag != ?', 1)
                        ->addwhere('ce.is_answered != ?', 2)
                        ->groupBy('ce.id')
                        ->orderBy('maxreplydate DESC, ce.enq_date desc');
						  		
		return $all_contact_post;
	}
        
        /*
         * Function for backend newletter enquiry
         */
        public function getAllNewContactEnquiryPostQueryNewsletter() 
	{
		/*$all_contact_post = Doctrine_Query::create()
						  ->from('ContactEnquiry ce')
						  ->orderBy('ce.enq_date DESC');*/
                
                $all_contact_post = Doctrine_Query::create()
                        ->select('cep.*, ce.*, IFNULL(max(cep.reply_date),ce.enq_date) as maxreplydate')
                        ->from('ContactEnquiry ce')
                        ->leftJoin('ce.ContactEnquiryPost cep ON ce.id = cep.enq_id')
                        ->where('ce.faster_ans_flag != ?', 1)
                        ->addwhere('ce.is_answered != ?', 2)
                        ->groupBy('ce.id')
                        ->orderBy('maxreplydate DESC, ce.enq_date desc')
                        ->limit(5);
						  		
		return $all_contact_post->execute();
	}
        
        /*
	*
	* This function returns all the contact enquiry which are related to specific id.
	*
	*/
	
	public function getSelctedContactEnquiryTopics($id) 
	{ 
		$selected_category = Doctrine_Query::create()
                                                        ->from('ContactEnquiry ce')
						       ->where('ce.enq_type = ?', $id)
						       ->orderBy('ce.enq_date DESC');
						  		
		return $selected_category;
	}
        
        /*
	*
	* This function returns all the forum topics which are related to specific id, in a specific order.
	*
	*/
	
	public function getOrderedSelctedEnquiryTopics($id, $column,$order) 
	{
                if($id == '1'){$enq_type = 'Portfölj';}
                elseif ($id == '2'){$enq_type = 'Henry Boy';}
                elseif ($id == '3'){$enq_type = 'Utbildningar';}
                elseif ($id == '4'){$enq_type = 'Webinarium';}
                elseif ($id == '5'){$enq_type = 'VIP-klubben';}
                elseif ($id == '6'){$enq_type = 'Nybörjare';}
                elseif ($id == '7'){$enq_type = 'Metastock';}
                elseif ($id == '8'){$enq_type = 'Förslagslåda';}
                elseif ($id == '9'){$enq_type = 'Kundtjänst';}
                elseif ($id == '10'){$enq_type = 'Övrigt';}
                elseif ($id == '11'){$enq_type = 'Senaste';}
        
		if($id) {
                    //$query = Doctrine_Query::create()->from('ContactEnquiry ce')->where('ce.enq_type = ?', array($enq_type));
                    $query = Doctrine_Query::create()
                        ->select('cep.*, ce.*, IFNULL(max(cep.reply_date),ce.enq_date) as maxreplydate')
                        ->from('ContactEnquiry ce')
                        ->leftJoin('ce.ContactEnquiryPost cep ON ce.id = cep.enq_id')
                        ->where('ce.enq_type = ?', array($enq_type))
                        ->addWhere('ce.faster_ans_flag != ?', 1)
                        ->addwhere('ce.is_answered != ?', 2)
                        ->groupBy('ce.id');
                }
		else{
                     /*$query = Doctrine_Query::create()->from('ContactEnquiry ce');*/
                     $query = Doctrine_Query::create()
                        ->select('cep.*, ce.*, IFNULL(max(cep.reply_date),ce.enq_date) as maxreplydate')
                        ->from('ContactEnquiry ce')
                        ->leftJoin('ce.ContactEnquiryPost cep ON ce.id = cep.enq_id')
                        ->where('ce.faster_ans_flag != ?', 1)
                        ->addwhere('ce.is_answered != ?', 2)
                        ->groupBy('ce.id');
                }
		
		if($column == 'subject') $query = $query->orderBy('ce.enq_subject '.$order);
		if($column == 'category') $query->orderBy('ce.enq_date '.$order);
		if($column == 'author') $query = $query->orderBy('ce.firstname '.$order);
		if($column == 'reply') $query = $query->orderBy('ce.replycount '.$order);
		if($column == 'view') $query = $query->orderBy('ce.visningar '.$order);
		if($column == 'date') $query = $query->orderBy('maxreplydate '.$order);
                if(!$column) $query = $query->orderBy('maxreplydate DESC, ce.enq_date desc');
		return $query;
                echo $query;
	}
        
        /**
	 * Gives the no. of reply to a topic
	 * $id Id of the topic.
	 */
	 public function getReplyCount($id)
	 {
		$reply_cnt_cri = Doctrine_Query::create()
	   					  ->from('ContactEnquiryPost cep')
						  ->where('cep.enq_id = ? ', array($id));
		
		$data = $reply_cnt_cri->execute();
		return count($data);
	 }
         
         /**
	 * Increments the view count of forum.
	 * $id Id of the topic.
	 */
	 public function increaseViewCount($id)
	 {
		$fetch_one_cri = Doctrine_Query::create()
       						->from('ContactEnquiry ce')
       						->where('ce.id = ?', $id);

                $rec = $fetch_one_cri->fetchOne();
		
		$total = 0;
		
		if($rec)
		{
			$total = $rec->visningar + 1;
			
			$category_name_cri = Doctrine_Query::create()
								->update('ContactEnquiry ce')
								->set('ce.visningar', '?', $total)
								->where('ce.id = ?', $id);
	
			$updated = $category_name_cri->execute();
		}

	 }
         
         /*
	*
	* This function fetches record.
	*
	*/
	public function fetchFastAnsFlagRec($id)
	{ 
		$query = Doctrine_Query::create()
	   		   ->from('ContactEnquiry ce')
			   ->where('ce.id = ?', $id);

		$data = $query->fetchOne();
		return $data->faster_ans_flag;
	}
	
}